<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Night checker - Flow</title>
    <meta name="theme-color" content="#0b0c10" />
    <!-- Mermaid CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({ startOnLoad: true });</script>
    <style>
      body { background:#0b0c10; color: #fff; font-family: system-ui, -apple-system, "Helvetica Neue", Arial; padding: 24px; }
      .card { background: #0f1115; border-radius: 8px; padding: 18px; max-width: 960px; margin: 0 auto; box-shadow: 0 2px 8px rgba(0,0,0,0.4); }
      .mermaid { color: #fff; }
      a { color: #9fd3ff }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Night checker — フローチャート</h1>
      <p>以下は night checker の主要フローです。ページが表示されない場合は、しばらく待ってから再読み込みしてください（Pages のビルド反映に数分かかる場合があります）。</p>

      <section style="background:#0d1114;border-radius:8px;padding:12px;margin:12px 0;border:1px solid rgba(255,255,255,0.04);">
        <h2 style="margin:0 0 8px 0;font-size:18px;">法務向け要約（簡潔）</h2>
        <p style="margin:0 0 8px 0;line-height:1.45;color:#dfeffd;">弁護士による速やかな確認用に、設計と責任範囲を平易にまとめています。必要に応じてこの文言を印刷・送付してください。</p>
        <ul style="margin:0 0 0 18px;padding:0;color:#dfeffd;">
          <li>目的：端末ローカルで動作する事実確認補助ツールです。診断や医療的助言は行いません。</li>
          <li>データ処理：記録は端末内のタイムライン（事象＋時刻）と構造化された通話/119 の事実のみを保持します。自由記述は恒久保存しません。</li>
          <li>通信：自動で外部へ送信・同期は行いません。記録の共有は利用者が手動でコピーして行います。</li>
          <li>責任範囲：本ツールは補助ツールです。最終的な判断・対応責任は現場の担当者（利用者）にあります。</li>
          <li>運用ルール：画面や文言を更新したら `sw.js` のキャッシュバージョンを更新し、配布端末へ最新版を周知してください。</li>
        </ul>
      </section>

      <div class="mermaid">
flowchart TD
  %% Nodes: high-level states and actions
  BOOT(["起動：画面表示と初期設定"])
  START(["最初の設定：施設名など（端末内保存）"])
  Q6(["事実確認（6つの質問）\n※質問は『今は様子を見る』か『要対応か』を整理するための確認"])
  RESULT_CALL(["連絡・対応の整理画面（事実の記録）\n・救急（119）\n・家族への連絡"])
  OBSERVE30(["様子を見る（30分）"])
  OBSERVE60(["様子を見る（60分）"])
  SLEEP(["睡眠の状況を記録（事実）"])
  HANDOFF(["引継ぎ（コピー用の記録文を作る）"])
  RECORD(["記録文を生成（コピー前提）\n・時系列（いつ何が起きたか）\n・119/家族連絡の事実\n※評価や断定は書かない"])
  RESET(["やり直し（端末内の入力をクリア）"])
  ERROR(["エラー：キャッシュ/読み込み失敗等"])

  %% Actions / side-effects
  RECORD_TIMELINE(["時系列に記録：出来事＋時刻（端末内）"])
  EMS_AUTO(["救急（119）の記録\n・緊急と判断した場合は自動で『119対応』を事実として記録\n・例外的な手動追加は固定の理由のみ（自由入力なし）"])
  FAMILY_CALL(["家族への連絡の記録\n・ワンタップで『つながった／つながらなかった』を記録\n・つながった場合は、決められた伝達文（事実）を記録に含める\n・自由記述は恒久保存しない"])
  SW_REGISTER(["オフライン対応（PWA）\n・一度開いた端末なら電波がなくても起動できるようにする\n・サーバ同期はしない"])

  %% Boot / registration
  BOOT -->|初期化: load model, render| START
  BOOT --> SW_REGISTER

  %% Main flow
  START --> Q6
  Q6 -->|危険あり| RESULT_CALL
  Q6 -->|異常なし| OBSERVE30
  RESULT_CALL -->|救急判定（緊急）| EMS_AUTO
  RESULT_CALL --> FAMILY_CALL

  %% OBSERVE flows
  OBSERVE30 -->|30分経過| OBSERVE60
  OBSERVE30 -->|本人拒否で6問不可ボタン| RECORD_TIMELINE & OBSERVE60
  OBSERVE60 -->|60分経過| SLEEP
  OBSERVE60 -->|本人拒否で6問不可ボタン| RECORD_TIMELINE & SLEEP

  %% timeline side-effects
  EMS_AUTO --> RECORD_TIMELINE
  FAMILY_CALL --> RECORD_TIMELINE

  %% record generation and handoff
  SLEEP --> HANDOFF
  HANDOFF --> RECORD
  RESULT_CALL --> RECORD

  %% Reset and errors
  RECORD --> RESET
  RESET --> START
  SW_REGISTER -->|登録失敗| ERROR
  ERROR --> BOOT

  %% explicit link labels for clarity
  click RECORD href "javascript:void(0)" "記録作成は UI 上の「記録用テキストをコピー」ボタンで実行"
      </div>
    </div>
  </body>
</html>
